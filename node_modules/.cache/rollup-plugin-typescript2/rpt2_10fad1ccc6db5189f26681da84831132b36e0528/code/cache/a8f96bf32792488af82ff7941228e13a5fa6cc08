{"code":"/****************************************************************************\r\n * Copyright 2021 EPAM Systems\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *    http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n ***************************************************************************/\r\nimport { Action, Scale, fromAtomsAttrs } from 'ketcher-core';\r\nclass ReactionMapTool {\r\n    editor;\r\n    rcs;\r\n    dragCtx;\r\n    line;\r\n    constructor(editor) {\r\n        this.editor = editor;\r\n        this.editor.selection(null);\r\n    }\r\n    mousedown(event) {\r\n        const rnd = this.editor.render;\r\n        this.rcs = rnd.ctab.molecule.getComponents();\r\n        const ci = this.editor.findItem(event, ['atoms']);\r\n        if (ci && ci.map === 'atoms') {\r\n            this.editor.hover(null);\r\n            this.dragCtx = {\r\n                item: ci,\r\n                xy0: rnd.page2obj(event)\r\n            };\r\n        }\r\n    }\r\n    mousemove(event) {\r\n        const editor = this.editor;\r\n        const rnd = editor.render;\r\n        if ('dragCtx' in this) {\r\n            const ci = this.editor.findItem(event, ['atoms'], this.dragCtx.item);\r\n            const atoms = rnd.ctab.molecule.atoms;\r\n            if (ci &&\r\n                ci.map === 'atoms' &&\r\n                isValidMap(this.rcs, this.dragCtx.item.id, ci.id)) {\r\n                editor.hover(ci);\r\n                this.updateLine(atoms.get(this.dragCtx.item.id)?.pp, atoms.get(ci.id)?.pp);\r\n            }\r\n            else {\r\n                editor.hover(null);\r\n                this.updateLine(atoms.get(this.dragCtx.item.id)?.pp, rnd.page2obj(event));\r\n            }\r\n        }\r\n        else {\r\n            editor.hover(editor.findItem(event, ['atoms']));\r\n        }\r\n    }\r\n    updateLine(p1, p2) {\r\n        if (this.line) {\r\n            this.line.remove();\r\n            this.line = null;\r\n        }\r\n        if (p1 && p2) {\r\n            const rnd = this.editor.render;\r\n            this.line = rnd.selectionLine(Scale.obj2scaled(p1, rnd.options).add(rnd.options.offset), Scale.obj2scaled(p2, rnd.options).add(rnd.options.offset));\r\n        }\r\n    }\r\n    mouseup(event) {\r\n        if ('dragCtx' in this) {\r\n            const rnd = this.editor.render;\r\n            const ci = this.editor.findItem(event, ['atoms'], this.dragCtx.item);\r\n            if (ci &&\r\n                ci.map === 'atoms' &&\r\n                isValidMap(this.rcs, this.dragCtx.item.id, ci.id)) {\r\n                const action = new Action();\r\n                const atoms = rnd.ctab.molecule.atoms;\r\n                const atom1 = atoms.get(this.dragCtx.item.id);\r\n                const atom2 = atoms.get(ci.id);\r\n                const aam1 = atom1?.aam;\r\n                const aam2 = atom2?.aam;\r\n                if (!aam1 || aam1 !== aam2) {\r\n                    if ((aam1 && aam1 !== aam2) || (!aam1 && aam2)) {\r\n                        // eslint-disable-line no-mixed-operators\r\n                        atoms.forEach((atom, aid) => {\r\n                            if (aid !== this.dragCtx.item.id &&\r\n                                ((aam1 && atom.aam === aam1) || (aam2 && atom.aam === aam2)))\r\n                                action.mergeWith(fromAtomsAttrs(rnd.ctab, aid, { aam: 0 }, null));\r\n                        });\r\n                    }\r\n                    if (aam1) {\r\n                        action.mergeWith(fromAtomsAttrs(rnd.ctab, ci.id, { aam: aam1 }, null));\r\n                    }\r\n                    else {\r\n                        let aam = 0;\r\n                        atoms.forEach((atom) => {\r\n                            aam = Math.max(aam, atom.aam || 0);\r\n                        });\r\n                        action.mergeWith(fromAtomsAttrs(rnd.ctab, this.dragCtx.item.id, { aam: aam + 1 }, null));\r\n                        action.mergeWith(fromAtomsAttrs(rnd.ctab, ci.id, { aam: aam + 1 }, null));\r\n                    }\r\n                    this.editor.update(action);\r\n                }\r\n            }\r\n            this.updateLine(null, null);\r\n            delete this.dragCtx;\r\n        }\r\n        this.editor.hover(null);\r\n    }\r\n}\r\nfunction isValidMap(rcs, aid1, aid2) {\r\n    let t1;\r\n    let t2;\r\n    for (let ri = 0; (!t1 || !t2) && ri < rcs.reactants.length; ri++) {\r\n        const ro = Array.from(rcs.reactants[ri]);\r\n        if (!t1 && ro.indexOf(aid1) >= 0) {\r\n            t1 = 'r';\r\n        }\r\n        if (!t2 && ro.indexOf(aid2) >= 0) {\r\n            t2 = 'r';\r\n        }\r\n    }\r\n    for (let pi = 0; (!t1 || !t2) && pi < rcs.products.length; pi++) {\r\n        const po = Array.from(rcs.products[pi]);\r\n        if (!t1 && po.indexOf(aid1) >= 0) {\r\n            t1 = 'p';\r\n        }\r\n        if (!t2 && po.indexOf(aid2) >= 0) {\r\n            t2 = 'p';\r\n        }\r\n    }\r\n    return t1 && t2 && t1 !== t2;\r\n}\r\nexport default ReactionMapTool;\r\n//# sourceMappingURL=reactionmap.js.map","references":["/home/ubuntu/work/4life/ketcher/packages/ketcher-core/dist/index.d.ts","/home/ubuntu/work/4life/ketcher/packages/ketcher-react/src/script/editor/Editor.ts"],"map":"{\"version\":3,\"file\":\"reactionmap.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../../../src/script/editor/tool/reactionmap.ts\"],\"names\":[],\"mappings\":\"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\"}","dts":{"name":"/home/ubuntu/work/4life/ketcher/packages/ketcher-react/node_modules/.cache/rollup-plugin-typescript2/placeholder/script/editor/tool/reactionmap.d.ts","writeByteOrderMark":false,"text":"/****************************************************************************\r\n * Copyright 2021 EPAM Systems\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *    http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n ***************************************************************************/\r\nimport Editor from '../Editor';\r\ndeclare class ReactionMapTool {\r\n    editor: Editor;\r\n    rcs: any;\r\n    dragCtx: any;\r\n    line: any;\r\n    constructor(editor: any);\r\n    mousedown(event: any): void;\r\n    mousemove(event: any): void;\r\n    updateLine(p1: any, p2: any): void;\r\n    mouseup(event: any): void;\r\n}\r\nexport default ReactionMapTool;\r\n"}}
